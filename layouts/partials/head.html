<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ if .Title }}{{ .Title }} - {{ end }}{{ .Site.Title }}</title>

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
<link rel="icon" type="image/x-icon" href="/favicon/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
<link rel="manifest" href="/favicon/site.webmanifest">

{{/* SEO and social sharing meta tags */}}
{{ partial "seo.html" . }}

<!-- Theme detection - MUST run before CSS to prevent flash -->
<script>
(function() {
    var theme = localStorage.getItem('theme');
    if (theme === 'night' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('night');
    }
    // Apply theme style class before CSS loads
    var themeStyle = localStorage.getItem('themeStyle') || 'fantasy';
    if (themeStyle !== 'fantasy') {
        document.documentElement.classList.add('theme-' + themeStyle);
    }
})();
</script>

<!-- Preload background images -->
<link rel="preload" href="/background/3.webp" as="image" type="image/webp">
<link rel="preload" href="/background/3_night.webp" as="image" type="image/webp">

<!-- Theme asset preloader -->
<script>
(function() {
    var currentTheme = localStorage.getItem('themeStyle') || 'fantasy';

    // Key assets to preload per theme
    function getThemeAssets(theme) {
        var base = '/' + theme;
        return [
            base + '/tiles/day_tiles.webp',
            base + '/tiles/tiles_night.webp',
            base + '/dropdown/drop_down_menu.webp',
            base + '/notes/top.webp',
            base + '/notes/middle.webp',
            base + '/notes/bottom.webp',
            base + '/notes/closed.webp',
            base + '/menu/sign.webp',
            base + '/sprites/cat/sheets/walk_east.png',
            base + '/sprites/cat/sheets/walk_west.png',
            base + '/sprites/cat/sheets/idle_south.png'
        ];
    }

    // Preload current theme assets
    var assets = getThemeAssets(currentTheme);
    assets.forEach(function(src) {
        var img = new Image();
        img.src = src;
    });

    // Expose preloader for theme switching
    window.preloadTheme = function(theme) {
        return new Promise(function(resolve) {
            var themeAssets = getThemeAssets(theme);
            var loaded = 0;
            var total = themeAssets.length;

            themeAssets.forEach(function(src) {
                var img = new Image();
                img.onload = img.onerror = function() {
                    loaded++;
                    if (loaded >= total) resolve();
                };
                img.src = src;
            });

            // Timeout fallback after 3 seconds
            setTimeout(resolve, 3000);
        });
    };
})();
</script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Spectral:wght@400;600&family=Uncial+Antiqua&family=Orbitron:wght@400;700&family=Share+Tech+Mono&family=IBM+Plex+Mono:wght@400;600&family=Teko:wght@400;600&family=Rajdhani:wght@400;600&family=Fira+Code:wght@400;600&family=Amatic+SC:wght@400;700&family=Cabin:wght@400;600&family=Merriweather:wght@400;700&family=Cinzel:wght@400;600&family=Quicksand:wght@400;500;600&family=Source+Sans+Pro:wght@400;600&family=Fredericka+the+Great&family=Literata:wght@400;600&family=IM+Fell+English:ital@0;1&family=Vollkorn:wght@400;600&family=EB+Garamond:wght@400;600&display=swap" rel="stylesheet">

<!-- Theme CSS -->
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/chaos.css">
<link rel="stylesheet" href="/css/themes.css">
<link rel="stylesheet" href="/css/achievements.css">
<link rel="stylesheet" href="/css/sierra-panel.css">

<!-- Custom CSS from micro.blog -->
{{ partial "custom_css.html" . }}

<!-- IndieWeb endpoints -->
<link rel="authorization_endpoint" href="https://micro.blog/indieauth/auth">
<link rel="token_endpoint" href="https://micro.blog/indieauth/token">
<link rel="micropub" href="https://micro.blog/micropub">
<link rel="webmention" href="https://micro.blog/webmention">
<link rel="microsub" href="https://micro.blog/microsub">

<!-- Social identity links -->
{{ with .Site.Params.twitter }}<link rel="me" href="https://twitter.com/{{ . }}">{{ end }}
{{ with .Site.Params.github }}<link rel="me" href="https://github.com/{{ . }}">{{ end }}
{{ with .Site.Params.instagram }}<link rel="me" href="https://instagram.com/{{ . }}">{{ end }}

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title="{{ .Site.Title }}" href="{{ .Site.BaseURL }}feed.xml">
<link rel="alternate" type="application/json" title="{{ .Site.Title }}" href="{{ .Site.BaseURL }}feed.json">

<!-- Plugin head HTML -->
{{ partial "plugin_head_html.html" . }}
{{ partial "plugin_css.html" . }}
