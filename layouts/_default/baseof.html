<!doctype html>
<html lang="en">
<head>
    {{- partial "head.html" . -}}
</head>
<body>

    <!-- Sierra-style Control Panel -->
    <div class="sierra-trigger"></div>
    <div class="sierra-panel">
        <div class="sierra-panel-bg">
            <div class="sierra-title"><span>Controls</span></div>
            <div class="sierra-buttons">
                <button class="sierra-btn" data-action="theme" data-tooltip="Day/Night">
                    <img class="btn-icon day-icon" src="/sprites/drop_down_icons/day.png" alt="Switch to day mode">
                    <img class="btn-icon night-icon" src="/sprites/drop_down_icons/night.png" alt="Switch to night mode" style="display:none">
                </button>
                <button class="sierra-btn" data-action="chaos" data-tooltip="Chaos Mode">
                    <img class="btn-icon" src="/sprites/drop_down_icons/swirl.png" alt="Toggle chaos mode effects">
                </button>
                <button class="sierra-btn" data-action="achievements" data-tooltip="Achievements">
                    <img class="btn-icon" src="/sprites/drop_down_icons/trophey.png" alt="View achievements panel">
                </button>
                <button class="sierra-btn" data-action="rainbow" data-tooltip="Rainbow">
                    <img class="btn-icon" src="/sprites/drop_down_icons/rainbow.png" alt="Toggle rainbow mode">
                </button>
                <button class="sierra-btn" data-action="weather" data-tooltip="Weather">
                    <img class="btn-icon weather-icon" src="/sprites/drop_down_icons/sun.png" alt="Cycle weather effects">
                </button>
                <button class="sierra-btn" data-action="help" data-tooltip="Help">
                    <img class="btn-icon" src="/sprites/drop_down_icons/help.png" alt="Show help information">
                </button>
            </div>
        </div>
    </div>

    <script>
        // Sierra Panel Button Handler
        (function() {
            const panel = document.querySelector('.sierra-panel');
            if (!panel) return;

            // Theme toggle - swap day/night icons
            function updateThemeButton() {
                const dayIcon = panel.querySelector('[data-action="theme"] .day-icon');
                const nightIcon = panel.querySelector('[data-action="theme"] .night-icon');
                const isNight = document.documentElement.classList.contains('night');
                // Show night icon (moon) when in day mode (to switch TO night)
                // Show day icon (sun) when in night mode (to switch TO day)
                if (dayIcon) dayIcon.style.display = isNight ? 'block' : 'none';
                if (nightIcon) nightIcon.style.display = isNight ? 'none' : 'block';
            }
            updateThemeButton();

            // Weather state and icons
            let currentWeather = null;
            const weatherIcons = {
                sun: '/sprites/drop_down_icons/sun.png',
                rain: '/sprites/drop_down_icons/rain.png',
                snow: '/sprites/drop_down_icons/snow.png'
            };

            panel.addEventListener('click', (e) => {
                const btn = e.target.closest('.sierra-btn');
                if (!btn) return;

                const action = btn.dataset.action;

                switch(action) {
                    case 'theme':
                        const isNight = document.documentElement.classList.toggle('night');
                        localStorage.setItem('theme', isNight ? 'night' : 'day');
                        updateThemeButton();
                        break;

                    case 'chaos':
                        if (window.chaos) {
                            if (document.body.classList.contains('chaos-mode')) {
                                window.chaos.disable();
                            } else {
                                window.chaos.enable();
                            }
                            btn.classList.toggle('active', document.body.classList.contains('chaos-mode'));
                        }
                        break;

                    case 'achievements':
                        if (window.achievementPanel) {
                            window.achievementPanel.toggle();
                            const achPanel = document.getElementById('achievements-panel');
                            btn.classList.toggle('active', achPanel && achPanel.classList.contains('open'));
                        }
                        break;

                    case 'rainbow':
                        if (window.chaos) {
                            window.chaos.rainbow();
                            btn.classList.toggle('active', document.body.classList.contains('rainbow-mode'));
                        }
                        break;

                    case 'weather':
                        const weatherIcon = btn.querySelector('.weather-icon');
                        if (window.chaosWeather) {
                            if (currentWeather === null) {
                                window.chaosWeather.rain();
                                currentWeather = 'rain';
                                if (weatherIcon) weatherIcon.src = weatherIcons.rain;
                            } else if (currentWeather === 'rain') {
                                window.chaosWeather.snow();
                                currentWeather = 'snow';
                                if (weatherIcon) weatherIcon.src = weatherIcons.snow;
                            } else {
                                window.chaosWeather.stop();
                                currentWeather = null;
                                if (weatherIcon) weatherIcon.src = weatherIcons.sun;
                            }
                            btn.classList.toggle('active', currentWeather !== null);
                        }
                        break;

                    case 'help':
                        showHelpPopup();
                        break;
                }
            });

            // Help popup function
            function showHelpPopup() {
                // Remove existing popup if any
                const existing = document.querySelector('.help-popup');
                if (existing) existing.remove();

                // Trigger help achievement
                if (window.achievementHooks?.onHelpClicked) {
                    window.achievementHooks.onHelpClicked();
                }

                const popup = document.createElement('div');
                popup.className = 'help-popup';
                popup.innerHTML = `
                    It's a website... why do you need help?
                    <button class="help-popup-close">OK, fair enough</button>
                `;

                document.body.appendChild(popup);

                // Trigger animation
                requestAnimationFrame(() => {
                    popup.classList.add('visible');
                });

                // Close button
                popup.querySelector('.help-popup-close').addEventListener('click', () => {
                    popup.classList.remove('visible');
                    setTimeout(() => popup.remove(), 300);
                    // Log chaos commands as a consolation
                    if (window.chaos) {
                        window.chaos.help();
                    }
                });

                // Click outside to close
                popup.addEventListener('click', (e) => {
                    if (e.target === popup) {
                        popup.classList.remove('visible');
                        setTimeout(() => popup.remove(), 300);
                    }
                });
            }
        })();
    </script>

    {{- partial "header.html" . -}}

    <script>
        // Mobile hamburger menu toggle
        (function() {
            const hamburger = document.querySelector('.nav-hamburger');
            const navLinks = document.querySelector('.nav-links');
            if (!hamburger || !navLinks) return;

            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('open');
                navLinks.classList.toggle('open');
                hamburger.setAttribute('aria-expanded',
                    hamburger.classList.contains('open'));
            });

            // Close menu when clicking a link
            navLinks.querySelectorAll('.nav-sign').forEach(link => {
                link.addEventListener('click', () => {
                    hamburger.classList.remove('open');
                    navLinks.classList.remove('open');
                    hamburger.setAttribute('aria-expanded', 'false');
                });
            });

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.site-nav') && navLinks.classList.contains('open')) {
                    hamburger.classList.remove('open');
                    navLinks.classList.remove('open');
                    hamburger.setAttribute('aria-expanded', 'false');
                }
            });
        })();
    </script>

    <main class="main-content">
        {{- block "main" . }}{{- end }}
    </main>

    {{- partial "footer.html" . -}}

    {{ partial "custom_footer.html" . }}
    {{ partial "plugin_js.html" . }}

    <!-- Chaos Goblin Mode -->
    <script src="/js/chaos.js?v={{ now.Unix }}"></script>
    <script src="/js/achievements.js?v={{ now.Unix }}"></script>
    <script src="/js/scroll-tiles.js?v={{ now.Unix }}"></script>
    <script src="/js/scroll-rollup.js?v={{ now.Unix }}"></script>
</body>
</html>
