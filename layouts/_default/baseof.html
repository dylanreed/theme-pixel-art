<!doctype html>
<html lang="en">
<head>
    {{- partial "head.html" . -}}
</head>
<body>

    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Sierra-style Control Panel -->
    <div class="sierra-trigger"></div>
    <div class="sierra-panel">
        <div class="sierra-panel-bg">
            <div class="sierra-title"><span>Controls</span></div>
            <div class="sierra-buttons">
                <button class="sierra-btn" data-action="theme" data-tooltip="Day/Night">
                    <img class="btn-icon day-icon" src="/sprites/drop_down_icons/day.webp" alt="Switch to day mode">
                    <img class="btn-icon night-icon" src="/sprites/drop_down_icons/night.webp" alt="Switch to night mode" style="display:none">
                </button>
                <button class="sierra-btn" data-action="weather" data-tooltip="Weather">
                    <img class="btn-icon weather-icon" src="/sprites/drop_down_icons/sun.webp" alt="Cycle weather effects">
                </button>
                <button class="sierra-btn" data-action="rainbow" data-tooltip="Rainbow">
                    <img class="btn-icon" src="/sprites/drop_down_icons/rainbow.webp" alt="Toggle rainbow mode">
                </button>
                <button class="sierra-btn" data-action="achievements" data-tooltip="Achievements">
                    <img class="btn-icon" src="/sprites/drop_down_icons/trophey.webp" alt="View achievements panel">
                </button>
                <button class="sierra-btn" data-action="mode" data-tooltip="Theme: Fantasy">
                    <img class="btn-icon mode-icon" src="/modes/fantasy.webp" alt="Cycle visual theme">
                </button>
                <button class="sierra-btn" data-action="chaos" data-tooltip="Chaos">
                    <img class="btn-icon" src="/sprites/drop_down_icons/swirl.webp" alt="Toggle chaos mode">
                </button>
                <button class="sierra-btn" data-action="help" data-tooltip="Help">
                    <img class="btn-icon" src="/sprites/drop_down_icons/help.webp" alt="Show help information">
                </button>
            </div>
        </div>
    </div>

    <script>
        // Sierra Panel Button Handler
        (function() {
            const panel = document.querySelector('.sierra-panel');
            if (!panel) return;

            // Theme toggle - swap day/night icons
            function updateThemeButton() {
                const dayIcon = panel.querySelector('[data-action="theme"] .day-icon');
                const nightIcon = panel.querySelector('[data-action="theme"] .night-icon');
                const isNight = document.documentElement.classList.contains('night');
                // Show night icon (moon) when in day mode (to switch TO night)
                // Show day icon (sun) when in night mode (to switch TO day)
                if (dayIcon) dayIcon.style.display = isNight ? 'block' : 'none';
                if (nightIcon) nightIcon.style.display = isNight ? 'none' : 'block';
            }
            updateThemeButton();

            // Weather state and icons
            let currentWeather = null;
            const weatherIcons = {
                sun: '/sprites/drop_down_icons/sun.webp',
                rain: '/sprites/drop_down_icons/rain.webp',
                snow: '/sprites/drop_down_icons/snow.webp'
            };

            // Theme style state (fantasy, sci-fi, cyberpunk, cabin, underwater)
            const themes = ['fantasy', 'sci-fi', 'cyberpunk', 'cabin', 'underwater'];
            const themeNames = {
                'fantasy': 'Fantasy',
                'sci-fi': 'Sci-Fi',
                'cyberpunk': 'Cyberpunk',
                'cabin': 'Cabin',
                'underwater': 'Underwater'
            };
            const themeIcons = {
                'fantasy': '/modes/fantasy.webp',
                'sci-fi': '/modes/sci-fi.webp',
                'cyberpunk': '/modes/cyberpunk.webp',
                'cabin': '/modes/cabin.webp',
                'underwater': '/modes/underwater.webp'
            };
            let currentThemeIndex = 0;

            // Chaos mode easter egg tracking
            let modeClickCount = parseInt(localStorage.getItem('modeClickCount') || '0');
            let chaosUnlocked = localStorage.getItem('chaosUnlocked') === 'true';
            const CHAOS_CLICK_THRESHOLD = 25;
            const CHAOS_TIME_THRESHOLD = 5 * 60 * 1000; // 5 minutes in ms

            // Initialize theme from localStorage
            function initThemeStyle() {
                const savedTheme = localStorage.getItem('themeStyle') || 'fantasy';
                currentThemeIndex = themes.indexOf(savedTheme);
                if (currentThemeIndex === -1) currentThemeIndex = 0;
                applyThemeStyle(themes[currentThemeIndex], false);
            }

            function applyThemeStyle(theme, updateStorage = true) {
                // Remove all theme classes
                themes.forEach(t => {
                    if (t !== 'fantasy') {
                        document.documentElement.classList.remove('theme-' + t);
                    }
                });
                // Apply new theme (fantasy is default, no class needed)
                if (theme !== 'fantasy') {
                    document.documentElement.classList.add('theme-' + theme);
                }
                // Update button icon, tooltip and active state
                const modeBtn = panel.querySelector('[data-action="mode"]');
                if (modeBtn) {
                    const icon = modeBtn.querySelector('.mode-icon');
                    if (icon) {
                        icon.src = themeIcons[theme];
                        // Fallback to fantasy icon if theme icon fails to load
                        icon.onerror = function() {
                            this.src = '/modes/fantasy.webp';
                            this.onerror = null;
                        };
                    }
                    modeBtn.dataset.tooltip = 'Theme: ' + themeNames[theme];
                    modeBtn.classList.toggle('active', theme !== 'fantasy');
                }
                if (updateStorage) {
                    localStorage.setItem('themeStyle', theme);
                }
            }

            // Chaos mode easter egg - unlock after 25 clicks or 5 minutes
            function checkChaosUnlock() {
                if (chaosUnlocked) return;

                if (modeClickCount >= CHAOS_CLICK_THRESHOLD) {
                    unlockChaos('You clicked the theme button ' + CHAOS_CLICK_THRESHOLD + ' times! Chaos mode unlocked!');
                }
            }

            function unlockChaos(message) {
                if (chaosUnlocked) return;
                chaosUnlocked = true;
                localStorage.setItem('chaosUnlocked', 'true');

                // Enable chaos mode
                if (window.chaos) {
                    window.chaos.enable();
                    console.log('%c' + message, 'color: #ff00ff; font-size: 16px; font-weight: bold;');
                }
            }

            // Time-based chaos unlock (5 minutes on site)
            if (!chaosUnlocked) {
                setTimeout(() => {
                    unlockChaos('You\'ve been here for 5 minutes! Chaos mode unlocked!');
                }, CHAOS_TIME_THRESHOLD);
            }

            initThemeStyle();

            panel.addEventListener('click', (e) => {
                const btn = e.target.closest('.sierra-btn');
                if (!btn) return;

                const action = btn.dataset.action;

                switch(action) {
                    case 'theme':
                        const isNight = document.documentElement.classList.toggle('night');
                        localStorage.setItem('theme', isNight ? 'night' : 'day');
                        updateThemeButton();
                        break;

                    case 'mode':
                        // Increment click count for chaos easter egg
                        modeClickCount++;
                        localStorage.setItem('modeClickCount', modeClickCount.toString());
                        checkChaosUnlock();

                        // Cycle theme
                        currentThemeIndex = (currentThemeIndex + 1) % themes.length;
                        var newTheme = themes[currentThemeIndex];
                        applyThemeStyle(newTheme);

                        // Preload new theme assets before reloading
                        if (window.preloadTheme) {
                            btn.style.opacity = '0.5';
                            btn.style.pointerEvents = 'none';
                            window.preloadTheme(newTheme).then(function() {
                                location.reload();
                            });
                        } else {
                            location.reload();
                        }
                        break;

                    case 'achievements':
                        if (window.achievementPanel) {
                            window.achievementPanel.toggle();
                            const achPanel = document.getElementById('achievements-panel');
                            btn.classList.toggle('active', achPanel && achPanel.classList.contains('open'));
                        }
                        break;

                    case 'rainbow':
                        if (window.chaos) {
                            window.chaos.rainbow();
                            btn.classList.toggle('active', document.body.classList.contains('rainbow-mode'));
                        }
                        break;

                    case 'weather':
                        const weatherIcon = btn.querySelector('.weather-icon');
                        if (window.chaosWeather) {
                            if (currentWeather === null) {
                                window.chaosWeather.rain();
                                currentWeather = 'rain';
                                if (weatherIcon) weatherIcon.src = weatherIcons.rain;
                            } else if (currentWeather === 'rain') {
                                window.chaosWeather.snow();
                                currentWeather = 'snow';
                                if (weatherIcon) weatherIcon.src = weatherIcons.snow;
                            } else {
                                window.chaosWeather.stop();
                                currentWeather = null;
                                if (weatherIcon) weatherIcon.src = weatherIcons.sun;
                            }
                            btn.classList.toggle('active', currentWeather !== null);
                        }
                        break;

                    case 'chaos':
                        if (window.chaos) {
                            if (document.body.classList.contains('chaos-mode')) {
                                window.chaos.disable();
                            } else {
                                window.chaos.enable();
                            }
                            btn.classList.toggle('active', document.body.classList.contains('chaos-mode'));
                        }
                        break;

                    case 'help':
                        showHelpPopup();
                        break;
                }
            });

            // Help popup function
            function showHelpPopup() {
                // Remove existing popup if any
                const existing = document.querySelector('.help-popup');
                if (existing) existing.remove();

                // Trigger help achievement
                if (window.achievementHooks?.onHelpClicked) {
                    window.achievementHooks.onHelpClicked();
                }

                const popup = document.createElement('div');
                popup.className = 'help-popup';
                popup.innerHTML = `
                    It's a website... why do you need help?
                    <button class="help-popup-close">OK, fair enough</button>
                `;

                document.body.appendChild(popup);

                // Trigger animation
                requestAnimationFrame(() => {
                    popup.classList.add('visible');
                });

                // Close button
                popup.querySelector('.help-popup-close').addEventListener('click', () => {
                    popup.classList.remove('visible');
                    setTimeout(() => popup.remove(), 300);
                    // Log chaos commands as a consolation
                    if (window.chaos) {
                        window.chaos.help();
                    }
                });

                // Click outside to close
                popup.addEventListener('click', (e) => {
                    if (e.target === popup) {
                        popup.classList.remove('visible');
                        setTimeout(() => popup.remove(), 300);
                    }
                });
            }
        })();
    </script>

    {{- partial "header.html" . -}}

    <script>
        // Mobile hamburger menu toggle
        (function() {
            const hamburger = document.querySelector('.nav-hamburger');
            const navLinks = document.querySelector('.nav-links');
            if (!hamburger || !navLinks) return;

            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('open');
                navLinks.classList.toggle('open');
                hamburger.setAttribute('aria-expanded',
                    hamburger.classList.contains('open'));
            });

            // Close menu when clicking a link
            navLinks.querySelectorAll('.nav-sign').forEach(link => {
                link.addEventListener('click', () => {
                    hamburger.classList.remove('open');
                    navLinks.classList.remove('open');
                    hamburger.setAttribute('aria-expanded', 'false');
                });
            });

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.site-nav') && navLinks.classList.contains('open')) {
                    hamburger.classList.remove('open');
                    navLinks.classList.remove('open');
                    hamburger.setAttribute('aria-expanded', 'false');
                }
            });
        })();
    </script>

    <main id="main-content" class="main-content">
        {{- block "main" . }}{{- end }}
    </main>

    {{- partial "footer.html" . -}}

    <!-- Fixed UI Buttons -->
    <button id="back-to-top" class="fixed-btn fixed-btn-right" aria-label="Back to top" style="display: none;">
        ‚Üë TOP
    </button>
    <button id="easy-read-toggle" class="fixed-btn fixed-btn-left" aria-label="Toggle easy read mode">
        <span class="easy-label">üëÅ EASY</span>
        <span class="fancy-label" style="display: none;">‚ú® FANCY</span>
    </button>

    <script>
        // Back to Top Button
        (function() {
            const btn = document.getElementById('back-to-top');
            if (!btn) return;

            // Show/hide based on scroll position
            function checkScroll() {
                if (window.scrollY > 300) {
                    btn.style.display = 'block';
                } else {
                    btn.style.display = 'none';
                }
            }

            window.addEventListener('scroll', checkScroll, { passive: true });
            checkScroll();

            // Smooth scroll to top
            btn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        })();

        // Easy Read Mode Toggle
        (function() {
            const btn = document.getElementById('easy-read-toggle');
            if (!btn) return;

            const easyLabel = btn.querySelector('.easy-label');
            const fancyLabel = btn.querySelector('.fancy-label');

            // Initialize from localStorage
            const isEasyRead = localStorage.getItem('easyReadMode') === 'true';
            if (isEasyRead) {
                document.documentElement.classList.add('easy-read');
                easyLabel.style.display = 'none';
                fancyLabel.style.display = 'inline';
            }

            btn.addEventListener('click', () => {
                const willBeEasy = !document.documentElement.classList.contains('easy-read');
                document.documentElement.classList.toggle('easy-read', willBeEasy);
                localStorage.setItem('easyReadMode', willBeEasy);

                if (willBeEasy) {
                    easyLabel.style.display = 'none';
                    fancyLabel.style.display = 'inline';
                } else {
                    easyLabel.style.display = 'inline';
                    fancyLabel.style.display = 'none';
                }
            });
        })();
    </script>

    {{ partial "custom_footer.html" . }}
    {{ partial "plugin_js.html" . }}

    <!-- Chaos Goblin Mode -->
    <script src="/js/chaos.js?v={{ now.Unix }}"></script>
    <script src="/js/achievements.js?v={{ now.Unix }}"></script>
    <script src="/js/scroll-tiles.js?v={{ now.Unix }}"></script>
    <script src="/js/scroll-rollup.js?v={{ now.Unix }}"></script>
</body>
</html>
