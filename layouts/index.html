{{ define "main" }}
{{/* Get all posts - try Section first, fall back to filtering out pages for micro.blog */}}
{{ $posts := where .Site.RegularPages "Section" "posts" }}
{{ if eq (len $posts) 0 }}
    {{/* Micro.blog fallback: get all regular pages but exclude pages (about, archive, etc.) */}}
    {{ $posts = where .Site.RegularPages "Type" "post" }}
{{ end }}
{{ if eq (len $posts) 0 }}
    {{/* Final fallback: exclude pages by checking for page layout */}}
    {{ $posts = where .Site.RegularPages ".Params.layout" "!=" "page" }}
{{ end }}

{{/* Paginate the posts */}}
{{ $paginator := .Paginate $posts 25 }}

{{/* Track state for grouping blogs vs notes */}}
{{ $.Scratch.Set "inBlogGroup" false }}
{{ $.Scratch.Set "blogIndex" 0 }}

{{ range $paginator.Pages }}
    {{/* Note = no title OR explicitly marked as note */}}
    {{ $isNote := or (not .Title) (eq .Params.format "note") }}

    {{ if $isNote }}
        {{/* Close blog container if we were in one */}}
        {{ if $.Scratch.Get "inBlogGroup" }}
            </div></div>
            {{ $.Scratch.Set "inBlogGroup" false }}
        {{ end }}

        {{/* Render note as scroll */}}
        <article class="note-scroll">
            <div class="note-content">
                {{ .Content }}
            </div>
            <div class="note-meta">
                <a href="{{ .Permalink }}" class="note-date">{{ .Date.Format "January 2, 2006" }}</a>
            </div>
        </article>
    {{ else }}
        {{/* Open blog container if not already in one */}}
        {{ if not ($.Scratch.Get "inBlogGroup") }}
            <div class="posts-container"><div class="posts">
            {{ $.Scratch.Set "inBlogGroup" true }}
        {{ end }}

        {{/* Render blog post */}}
        {{ $blogIndex := $.Scratch.Get "blogIndex" }}
        <article class="post {{ partial "category-class.html" . }}{{ if eq $blogIndex 0 }} featured-post{{ end }}">
            {{/* Sprite based on first category */}}
            {{ partial "post-sprite.html" . }}

            <div class="post-body">
                {{/* Category tag - links to category page */}}
                {{ with .Params.categories }}
                    {{ range first 1 . }}
                    <a href="/categories/{{ . | urlize }}/" class="post-tag">{{ . }}</a>
                    {{ end }}
                {{ end }}

                {{/* Post title - only show if exists */}}
                {{ if .Title }}
                <h2 class="post-title">
                    <a href="{{ .Permalink }}">{{ .Title }}</a>
                </h2>
                {{ end }}

                {{/* Post date */}}
                <div class="post-meta">{{ .Date.Format "January 2, 2006" }}</div>

                {{/* First blog post: summary. Rest: just title and date */}}
                {{ if eq $blogIndex 0 }}
                <div class="post-excerpt">
                    {{ if .Summary }}
                        {{ .Summary | plainify | truncate 200 }}
                    {{ else }}
                        {{ .Content | plainify | truncate 200 }}
                    {{ end }}
                </div>
                <a href="{{ .Permalink }}" class="post-link">Read more &rarr;</a>
                {{ end }}
            </div>
        </article>
        {{ $.Scratch.Set "blogIndex" (add $blogIndex 1) }}
    {{ end }}
{{ end }}

{{/* Close blog container if still open */}}
{{ if $.Scratch.Get "inBlogGroup" }}
    </div></div>
{{ end }}

{{/* Pagination */}}
{{ if gt $paginator.TotalPages 1 }}
<nav class="pagination">
    {{ if $paginator.HasPrev }}
    <a href="{{ $paginator.Prev.URL }}" class="pagination-prev">&larr; Newer</a>
    {{ end }}

    <span class="pagination-info">Page {{ $paginator.PageNumber }} of {{ $paginator.TotalPages }}</span>

    {{ if $paginator.HasNext }}
    <a href="{{ $paginator.Next.URL }}" class="pagination-next">Older &rarr;</a>
    {{ end }}
</nav>
{{ end }}
{{ end }}
